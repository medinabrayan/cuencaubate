<!DOCTYPE html>
<html lang="es">
<head>
    <!-- METADATOS BÁSICOS -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identificador de Plantas - Cuenca Ubaté</title>
    
    <!-- HOJAS DE ESTILO EXTERNAS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- ESTILOS CSS -->
    <style>
        /* VARIABLES DE COLOR (paleta de colores principal) */
        :root {
            --primary: #38A169;       /* Verde principal */
            --primary-light: #48BB78;  /* Verde claro */
            --primary-dark: #2F855A;   /* Verde oscuro */
            --secondary: #ECC94B;      /* Amarillo para acentos */
            --light: #F0FFF4;          /* Fondo claro */
            --dark: #1A202C;           /* Texto oscuro */
            --gray: #718096;           /* Texto gris */
            --light-gray: #EDF2F7;     /* Fondo gris claro */
            --error: #E53E3E;          /* Rojo para errores */
            --pending: #ED8936;        /* Naranja para pendientes */
        }
        
        /* ESTILOS GENERALES */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #F7FAFC;
            color: var(--dark);
            line-height: 1.6;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ========== MENÚ DE RETORNO AL INICIO ========== */
        /* Contenedor del menú de retorno */
        .return-menu {
            background-color: var(--primary-dark);  /* Fondo verde oscuro */
            padding: 0.5rem 1rem;                  /* Espaciado interno */
            display: flex;
            align-items: center;
        }
        
        /* Estilo del enlace de retorno */
        .return-link {
            color: white;               /* Texto blanco */
            text-decoration: none;      /* Sin subrayado */
            display: flex;
            align-items: center;
            gap: 0.5rem;               /* Espacio entre icono y texto */
            font-size: 0.9rem;          /* Tamaño de fuente */
            transition: opacity 0.2s;    /* Transición suave al hover */
        }
        
        /* Efecto hover para el enlace */
        .return-link:hover {
            opacity: 0.8;
        }
        
        /* Icono de flecha */
        .return-link i {
            font-size: 1rem;
        }
        
        /* ========== CABECERA PRINCIPAL ========== */
        header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* Contenedor del contenido del header */
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Estilo del logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Icono del logo */
        .logo i {
            font-size: 1.8rem;
        }
        
        /* ========== CONTENIDO PRINCIPAL ========== */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            flex: 1;
        }
        
        /* Sección hero (título y descripción) */
        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .hero p {
            font-size: 1.1rem;
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto 2rem;
        }
        
        /* Tarjeta principal del identificador */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            padding: 2.5rem;
            margin-bottom: 3rem;
        }
        
        /* ========== ÁREA DE SUBIDA DE IMÁGENES ========== */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }
        
        .upload-area:hover {
            background-color: rgba(56, 161, 105, 0.05);
            border-color: var(--primary-dark);
        }
        
        /* Icono de subida */
        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        /* Texto del área de subida */
        .upload-text {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }
        
        .upload-text strong {
            color: var(--primary);
        }
        
        /* Input de archivo oculto */
        #fileInput {
            display: none;
        }
        
        /* ========== BOTONES ========== */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Botón secundario */
        .btn-secondary {
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background-color: var(--light);
        }
        
        /* Botón para pendientes */
        .btn-pending {
            background-color: var(--pending);
        }
        
        .btn-pending:hover {
            background-color: #DD6B20;
        }
        
        /* ========== VISTA PREVIA DE IMAGEN ========== */
        .preview-container {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            object-fit: contain;
        }
        
        /* ========== CONTROLES DE ACCIÓN ========== */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        /* ========== INDICADOR DE CARGA ========== */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            margin: 2rem 0;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ========== RESULTADOS DE IDENTIFICACIÓN ========== */
        .result-container {
            margin-top: 2rem;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Encabezado de resultados */
        .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .result-icon {
            font-size: 2rem;
            color: var(--primary);
        }
        
        /* Nombre de la planta */
        .plant-name {
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }
        
        /* Probabilidad de acierto */
        .probability {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--dark);
            padding: 0.3rem 1rem;
            border-radius: 50px;
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        /* Nombres comunes */
        .common-names {
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--light-gray);
            border-radius: 8px;
        }
        
        .common-names i {
            color: var(--primary);
            margin-right: 0.5rem;
        }
        
        /* ========== SECCIÓN DE DETALLES ========== */
        .details-section {
            margin-top: 2rem;
        }
        
        .details-section h3 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .details-section h3 i {
            font-size: 1.2rem;
        }
        
        .details-content {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .details-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        
        /* ========== FUENTES DE INFORMACIÓN ========== */
        .sources {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .sources-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .source-link {
            color: var(--primary);
            text-decoration: none;
            margin-right: 1rem;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        .source-link:hover {
            text-decoration: underline;
        }
        
        /* ========== MENSAJES DE ERROR ========== */
        .error-message {
            color: var(--error);
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: rgba(229, 62, 62, 0.1);
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 0.7rem;
        }
        
        .error-message i {
            font-size: 1.3rem;
        }
        
        /* ========== MENSAJE DE ÉXITO ========== */
        .success-message {
            color: var(--primary-dark);
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: rgba(56, 161, 105, 0.1);
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 0.7rem;
        }
        
        .success-message i {
            font-size: 1.3rem;
        }
        
        /* ========== PIE DE PÁGINA ========== */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .footer-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .footer-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .footer-link {
            color: white;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .footer-link:hover {
            color: var(--primary-light);
        }
        
        .copyright {
            font-size: 0.9rem;
            color: var(--light-gray);
            text-align: center;
        }
        
        /* ========== DISEÑO RESPONSIVE ========== */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ========== MENÚ DE RETORNO AL INICIO ========== -->
    <!-- Este menú aparece en la parte superior y permite volver a la página principal -->
    <div class="return-menu">
        <a href="bienvenido.html" class="return-link">
            <i class="fas fa-arrow-left"></i>
            Volver al Inicio
        </a>
    </div>

    <!-- ========== CABECERA PRINCIPAL ========== -->
    <header>
        <div class="header-content">
            <!-- Logo de la aplicación -->
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <span>Plantas Cuenca Ubaté</span>
            </div>
            
            
        </div>
    </header>

    <!-- ========== CONTENIDO PRINCIPAL ========== -->
    <main class="container">
        <!-- Sección hero con título y descripción -->
        <section class="hero">
            <h1>Identificador de Plantas</h1>
            <p>Sube una foto de cualquier planta de la Cuenca Ubaté y obtén información detallada</p>
        </section>

        <!-- Tarjeta principal que contiene el identificador -->
        <div class="card">
            <!-- Área para subir imágenes -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p class="upload-text"><strong>Haz clic para subir una imagen</strong> o arrástrala y suéltala aquí</p>
                <p class="upload-text">Formatos soportados: JPG, PNG, WEBP</p>
                <input type="file" id="fileInput" accept="image/*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> Seleccionar imagen
                </button>
            </div>

            <!-- Contenedor para la vista previa de la imagen -->
            <div class="preview-container">
                <img id="previewImage" class="preview-image" alt="Vista previa de la imagen">
            </div>

            <!-- Botones de acción -->
            <div class="action-buttons">
                <button id="identifyBtn" class="btn" disabled onclick="identifyPlant()">
                    <i class="fas fa-search"></i> Identificar planta
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Limpiar
                </button>
            </div>

            <!-- Indicador de carga -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Analizando tu planta...</p>
            </div>

            <!-- Mensaje de error -->
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- Mensaje de éxito -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <span id="successText"></span>
            </div>

            <!-- Contenedor de resultados (inicialmente oculto) -->
            <div class="result-container" id="resultContainer">
                <div class="result-header">
                    <div class="result-icon">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <h2>Resultados de identificación</h2>
                </div>

                <!-- Nombre de la planta identificada -->
                <h3 class="plant-name" id="plantName"></h3>
                
                <!-- Probabilidad de acierto -->
                <div class="probability" id="probability"></div>
                
                <!-- Nombres comunes -->
                <div class="common-names" id="commonNames">
                    <i class="fas fa-tags"></i>
                    <span id="commonNamesText"></span>
                </div>

                <!-- Sección de detalles -->
                <div class="details-section">
                    <h3><i class="fas fa-info-circle"></i> Descripción generada por IA</h3>
                    <div class="details-content" id="plantDetails"></div>
                    
                    <!-- Fuentes de información -->
                    <div class="sources">
                        <div class="sources-title">Fuentes consultadas:</div>
                        <div id="sourceLinks"></div>
                        <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--gray);">
                            Información recopilada de bases de datos botánicas de la región Cuenca Ubaté
                        </p>
                    </div>
                </div>

                <!-- Botón para guardar la planta identificada -->
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button id="savePlantBtn" class="btn" onclick="savePlant()" style="display: none;">
                        <i class="fas fa-save"></i> Guardar en Mis Plantas
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ========== PIE DE PÁGINA ========== -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-leaf"></i>
                <span>Plantas Cuenca Ubaté</span>
            </div>
            <div class="footer-links">
                <a href="identificador-plantas.html" class="footer-link">Identificar</a>
                <a href="guardar-plantas.html" class="footer-link">Mis Plantas</a>
            </div>
            <p class="copyright">Datos botánicos recopilados de fuentes especializadas de la región Cuenca Ubaté</p>
        </div>
    </footer>

    <!-- ========== SCRIPTS JAVASCRIPT ========== -->
    <script>
        localStorage.clear();
        // API Keys (en un entorno real, estas deberían manejarse de forma segura)
        const PLANT_ID_API_KEY = "aseeVTgH8L4T7yskaTc6gNHJ9STzOqLtOapCEvLr12oOGqf1gt";
        const DEEPSEEK_API_KEY = "sk-93a2f73354c14faf8121c0bab5935598";
        
        // Variables globales para almacenar datos de la planta identificada
        let currentPlantData = null;
        let currentPlantImage = null;
        
        // Fuentes confiables para consultar información (actualizadas a Wikipedia, iNaturalist y GBIF)
        const TRUSTED_SOURCES = [
            {
                name: "Wikipedia",
                url: (plantName) => `https://es.wikipedia.org/wiki/${encodeURIComponent(plantName)}`
            },
            {
                name: "iNaturalist",
                url: (plantName) => `https://www.inaturalist.org/taxa/search?q=${encodeURIComponent(plantName)}`
            },
            {
                name: "GBIF",
                url: (plantName) => `https://www.gbif.org/species/search?q=${encodeURIComponent(plantName)}`
            }
        ];
        
        // Elementos del DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const identifyBtn = document.getElementById('identifyBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const plantName = document.getElementById('plantName');
        const probability = document.getElementById('probability');
        const commonNamesText = document.getElementById('commonNamesText');
        const plantDetails = document.getElementById('plantDetails');
        const sourceLinks = document.getElementById('sourceLinks');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        const savePlantBtn = document.getElementById('savePlantBtn');
        
        // ========== EVENTOS PARA EL ÁREA DE SUBIDA ==========
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'rgba(56, 161, 105, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = 'white';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = 'white';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        fileInput.addEventListener('change', handleFileSelect);
        
        // Función para manejar la selección de archivos
        function handleFileSelect() {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    currentPlantImage = e.target.result; // Guardar la imagen para posible guardado
                };
                reader.readAsDataURL(file);
                
                // Habilitar botón de identificación
                identifyBtn.disabled = false;
                
                // Ocultar resultados anteriores
                resultContainer.style.display = 'none';
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                savePlantBtn.style.display = 'none';
            }
        }
        
        // ========== FUNCIÓN PRINCIPAL DE IDENTIFICACIÓN ==========
        async function identifyPlant() {
            if (!fileInput.files[0]) {
                showError('Por favor selecciona una imagen primero');
                return;
            }
            
            // Mostrar indicador de carga
            loading.style.display = 'flex';
            identifyBtn.disabled = true;
            resultContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            savePlantBtn.style.display = 'none';
            
            try {
                // Convertir imagen a Base64
                const base64Image = await toBase64(fileInput.files[0]);
                
                // 1. Identificar la planta con Plant.id API
                const plantIdResponse = await fetch('https://api.plant.id/v2/identify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Api-Key': PLANT_ID_API_KEY
                    },
                    body: JSON.stringify({
                        images: [base64Image],
                        plant_details: ['common_names']
                    })
                });
                
                const plantIdData = await plantIdResponse.json();
                
                if (!plantIdResponse.ok) {
                    throw new Error(plantIdData.error || 'Error al identificar la planta');
                }
                
                if (!plantIdData.suggestions || plantIdData.suggestions.length === 0) {
                    throw new Error('No se pudo identificar la planta. Intenta con otra imagen más clara.');
                }
                
                const bestMatch = plantIdData.suggestions[0];
                currentPlantData = bestMatch; // Guardar datos para posible guardado
                const scientificName = bestMatch.plant_name || 'Planta desconocida';
                
                // 2. Obtener descripción de la planta (simulada para este ejemplo)
                const description = await getPlantDescription(scientificName);
                
                // 3. Mostrar resultados
                displayResults(bestMatch, description);
                
                // Mostrar botón para guardar la planta
                savePlantBtn.style.display = 'inline-flex';
                
            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
                identifyBtn.disabled = false;
            }
        }
        
        // Función simulada para obtener descripción de la planta
        async function getPlantDescription(plantName) {
            try {
                // Simulación de respuesta de IA
                return simulateDeepSeekResponse(plantName);
                
            } catch (error) {
                console.error('Error al obtener descripción:', error);
                return await getDescriptionFromAlternativeSources(plantName);
            }
        }
        
        // Base de conocimiento simulada con enfoque regional
        function simulateDeepSeekResponse(plantName) {
            const plantKnowledge = {
                "Quercus humboldtii": "El roble andino (Quercus humboldtii) es una especie endémica de los Andes, común en la Cuenca Ubaté. Árbol de hasta 25 m de altura, con hojas coriáceas y bordes aserrados. Especie clave en los bosques altoandinos de la región.",
                "Espeletia spp": "Conocidas como frailejones, son plantas emblemáticas de los páramos de la Cuenca Ubaté. Crecen lentamente (1-2 cm/año) y son fundamentales para la captación de agua en la región.",
                "Polylepis spp": "Conocidos como árboles de papel, forman bosques en alturas extremas en la Cuenca Ubaté. Especies importantes para la conservación del ecosistema paramuno.",
                "default": `Descripción de ${plantName} en la Cuenca Ubaté. Esta planta presenta características típicas de la flora regional, con adaptaciones específicas al clima y altitud de la zona. Su presencia contribuye a la biodiversidad local.`
            };
            
            return plantKnowledge[plantName] || plantKnowledge['default'];
        }
        
        // Función alternativa para obtener descripción
        async function getDescriptionFromAlternativeSources(plantName) {
            return `Información recopilada de registros botánicos de la Cuenca Ubaté sobre ${plantName}. Los datos incluyen características observadas en especímenes de la región.`;
        }
        
        // ========== MOSTRAR RESULTADOS ==========
        function displayResults(plantData, description) {
            const scientificName = plantData.plant_name || 'Planta desconocida';
            
            // Mostrar nombre y probabilidad
            plantName.textContent = scientificName;
            probability.textContent = `Confianza: ${(plantData.probability * 100).toFixed(1)}%`;
            
            // Mostrar nombres comunes
            if (plantData.plant_details?.common_names) {
                commonNamesText.textContent = plantData.plant_details.common_names.join(', ');
            } else {
                commonNamesText.textContent = 'No se encontraron nombres comunes';
            }
            
            // Mostrar descripción
            plantDetails.innerHTML = '';
            const descriptionElement = document.createElement('p');
            descriptionElement.textContent = description;
            plantDetails.appendChild(descriptionElement);
            
            // Mostrar fuentes confiables
            displaySourceLinks(scientificName);
            
            // Mostrar resultados
            resultContainer.style.display = 'block';
        }
        
        // Mostrar enlaces a fuentes de información
        function displaySourceLinks(plantName) {
            sourceLinks.innerHTML = '';
            
            TRUSTED_SOURCES.forEach(source => {
                const link = document.createElement('a');
                link.href = source.url(plantName);
                link.textContent = source.name;
                link.className = 'source-link';
                link.target = '_blank';
                sourceLinks.appendChild(link);
            });
        }
        
        // ========== FUNCIÓN PARA GUARDAR PLANTA EN MIS PLANTAS ==========
        async function savePlant() {
            if (!currentPlantData || !currentPlantImage) {
                showError('No hay datos de planta para guardar');
                return;
            }
            
            // Deshabilitar botón mientras se guarda
            savePlantBtn.disabled = true;
            savePlantBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                // 1. Guardar en localStorage para acceso inmediato
                const savedPlants = JSON.parse(localStorage.getItem('savedPlants')) || [];
                
                const plantToSave = {
                    id: Date.now(), // ID único basado en timestamp
                    name: currentPlantData.plant_name,
                    commonName: currentPlantData.plant_details?.common_names?.[0] || 'Sin nombre común',
                    image: currentPlantImage,
                    dateSaved: new Date().toISOString(),
                    probability: currentPlantData.probability,
                    sources: TRUSTED_SOURCES.map(source => ({
                        name: source.name,
                        url: source.url(currentPlantData.plant_name)
                    })),
                    status: 'pending' // Estado inicial (pendiente de revisión)
                };
                
                savedPlants.unshift(plantToSave);
                localStorage.setItem('savedPlants', JSON.stringify(savedPlants));
                
                // 2. Guardar en la base de datos del servidor
                // const response = await fetch('guardar_planta.php', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json'
                //     },
                //     body: JSON.stringify({
                //         nombre_cientifico: plantToSave.name,
                //         nombre_comun: plantToSave.commonName,
                //         imagen: plantToSave.image.split(',')[1], // Solo la parte base64
                //         probabilidad: plantToSave.probability,
                //         fecha_guardado: plantToSave.dateSaved,
                //         estado: plantToSave.status,
                //         usuario: 'usuario_actual' // En un sistema real, usarías el usuario autenticado
                //     })
                // });
                const formData = new FormData();
                formData.append('file', fileInput.files[0]); 
                const response = await fetch('http://127.0.0.1:8000/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                // Consumir el endpoint para guardar datos de la imagen
                const params = new URLSearchParams({
                    filename: result.filename || fileInput.files[0].name,
                    nombre_usuario: 'usuario_actual',
                    description: '',
                    estado: 'revisando'
                }).toString();

                await fetch(`http://127.0.0.1:8000/save-image-data?${params}`, {
                    method: 'POST'
                });
                

                
                if (!result.success) {
                    throw new Error(result.message || 'Error al guardar en el servidor');
                }
                
                // Mostrar mensaje de éxito
                showSuccess('Planta guardada correctamente. Aparecerá en "Mis Plantas" y en la Galería después de revisión.');
                
                // Ocultar botón de guardado para evitar duplicados
                savePlantBtn.style.display = 'none';
                
            } catch (error) {
                showError('Error al guardar la planta: ' + error.message);
                console.error('Error al guardar:', error);
            } finally {
                // Restaurar estado del botón
                savePlantBtn.disabled = false;
                savePlantBtn.innerHTML = '<i class="fas fa-save"></i> Guardar en Mis Plantas';
            }
        }
        
        // ========== FUNCIONES UTILITARIAS ==========
        // Convertir archivo a Base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        // Mostrar mensaje de error
        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.display = 'flex';
            successMessage.style.display = 'none';
        }
        
        // Mostrar mensaje de éxito
        function showSuccess(message) {
            successText.textContent = message;
            successMessage.style.display = 'flex';
            errorMessage.style.display = 'none';
        }
        
        // Reiniciar el formulario
        function resetForm() {
            fileInput.value = '';
            previewImage.style.display = 'none';
            identifyBtn.disabled = true;
            resultContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            loading.style.display = 'none';
            savePlantBtn.style.display = 'none';
            currentPlantData = null;
            currentPlantImage = null;
        }
    </script>
</body>
</html>